<div align="center"><h2>Морозова Юлия, OTUS, группа Postgre-DBA-2023-11</h2></div>


<div align=center><h3>Домашнее задание №7 по теме: «Блокировки PostgreSQL»</h3></div>  

***

<br/><br/>

**I. Настройте сервер так, чтобы в журнал сообщений сбрасывалась информация о блокировках, удерживаемых более 200 миллисекунд. Воспроизведите ситуацию, при которой в журнале появятся такие сообщения.**

1. На моей ранее созданной ВМ в ЯО устанавливаю устанавливаю PostgreSQL 15 версии, подключаюсь к нему, для тестов создаю БД ``locks``, подключаюсь, проверяю соответствующие параметры: ``log_lock_waits`` , ``deadlock_timeout`` , изменяю их согласно условию задания:
    ```sql
    alter system set log_lock_waits = on;
    alter system set deadlock_timeout = 200;
    ```
    
    обновляю конфигурацию кластера, снова проверяю, все ок:

    ![1_1](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/5740c0dc-4228-4b27-b582-e286e667cbf0)

<br/><br/>

2. Для того, чтобы воспроизвести ситуацию, при которой в журнале появятся такие сообщения, сначала сделаю таблицу ``accounts`` , вставлю три строки:

    ![1_2](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/064853aa-fb67-4c78-8b6a-828f180f5327)

     открываю еще один терминал ssh , подключаюсь к БД locks, селект из таблицы  ``accounts`` - ок:

      ![1_3](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/f0dd5411-eb96-446c-919a-779fb1397e5d)

 
   в первом терминале начинаю транзакцию и пытаюсь обновить строку:

    ![1_22_1](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/484491de-7fe5-49a8-9450-a6073a8dd002)

   во втором терминале тоже открываю транзакцию и тоже пытаюсь обновить эту же строку и подвисаю:

    ![1_22_2](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/970a4708-b19f-4204-b192-b6caf073061e)

   жду более 200 мс и первом терминале завершаю транзакцию и смотрю номер обслуживающего процесса:  

   ![1_22_3](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/d8ebee3a-cc75-4906-b464-b1ede00b4d07)

    во втором терминале зависания уже нет, завершаю транзакцию и тоже смотрю номер обслуживающего процесса:

   ![1_22_4](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/e91b2e93-1e6a-489f-b4a1-9dc09d01234a)

   для наглядности логов, открываю третий терминал, в нем смотрю лог и да, информация про блокировки сессий с соответсвующими номерами и операторами  в лог. файле есть:

   ![1_22_5](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/c6ed31a9-dc75-4800-b523-2b39fd4a6019)

**Таким образом делаю вывод, что я настроила postgres так, чтобы в журнал сообщений сбрасывалась информация о блокировках, удерживаемых более 200 миллисекунд.**
   
<br/><br/>

**II.Смоделируйте ситуацию обновления одной и той же строки тремя командами UPDATE в разных сеансах. Изучите возникшие блокировки в представлении pg_locks и убедитесь, что все они понятны. Пришлите список блокировок и объясните, что значит каждая.**

1. Открываю 3 терминала(ssh) и в первом создаю представление над pg_locks (как на курсах) ``locks_v``:

    ![2_1_0](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/3de91632-5f2d-49cb-bd46-e183c9ab672a)

2. во всех 3х терминалах идентифицирую транзакции и сессии, начинаю транзакцию и пытаюсь обновить одну и ту же строку командой: ``UPDATE accounts SET amount = amount + 100.00 WHERE acc_no = 1;``

   Первая транзакция обновляет и ожидаемо блокирует строку:

   ![2_1_1](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/16088dcd-01d8-4f54-a375-1188e08de134)

   вторая транзакция пытается тоже обновить строку и ожидаемо подвисает:

    ![2_1_2](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/a73ca8a5-77d1-4454-9c17-1315eef21092)

   и третья тоже самое обновляет и так же подвисает:

    ![2_1_3](https://github.com/Y-M-Morozova/7_homework_Morozova_Yulia/assets/153178571/c8f059c3-55e6-478b-90e7-1213dbcb9d40)

   
 3. Смотрим блокировки транзакций с помощью созданного представления над pg_locks.
    Первая транзакция:  


